extends ../layoutsimplechat

block content
  link(href='https://cdnjs.cloudflare.com/ajax/libs/tippy.js/2.5.4/tippy.css')
  script(src='https://cdnjs.cloudflare.com/ajax/libs/tippy.js/2.5.4/tippy.min.js')
  script.
    var boxy = document.getElementById("threebox").getAttribute("data-value");
    tippy('#messages', { target: '.tooltippy' });
  #peersCount
  #ethaccount(data-value=ethaddress)
  #daccount(data-value=mainaddress)
  div(style='background-color:#111;padding:20px;width:100%;text-align:center;')
    span#loader(style='text-align: center; color: #fff; vertical-align: middle;') Encrypting & Connecting...Please wait...
    span#connectdot(style='text-align: center; color: #46a900; vertical-align: middle;')
  #logingroup(style='')
    .input-group#alias(style='width:350px;margin:0 auto;top: 50%;left: 40%;position: absolute;z-index:10002;')
      input.blackinputchat.form-control#entername(type='text', placeholder='Enter an alias to start chatting...', maxlength='15' autofocus)
      span#enter.input-group-addon(style='background-color:#222;color:#999;border-color: #444;border-top-right-radius:15px;border-bottom-right-radius:15px;outline:none;cursor:pointer;', onClick='enterChat()')
        i.fas.fa-arrow-circle-right
  #loginbg(style='background: rgb(56,56,56);background: radial-gradient(circle, rgba(56,56,56,1) 0%, rgba(17,17,17,1) 77%);width: 100%;height: calc(100% - 122px);position: absolute; z-index: 1000;')
  #messagewrapper(style='margin: 0 auto;margin-top:0px;overflow-x:hidden;display: flex;flex-direction: column-reverse;background-color:#111;border-bottom-left-radius:15px;border-bottom-right-radius:15px;padding:30px;width:95%;height: calc(100vh - 250px); position: absolute;left: 50%;transform: translate(-50%, 0);overflow-y: scroll;margin-bottom:15px;')
    #messagehodler(style='')
      #messages
  .input-group#chatinput(style='display:none;bottom:25px;position: absolute;left: 50%;transform: translate(-50%, -35px);width:95%;z-index:999;margin:0 auto;')
    input.blackinputchat#message.form-control(type='text', placeholder='Type a message...', data-value=ethaddress, data-emoji-input="unicode" autofocus)
    span#cancelpm.input-group-addon(onclick='swapPublic()', style='display:none;background-color:#222;color:#999;border-left: none;border-color: #444;outline:none;cursor:pointer;')
      i.fas.fa-comment-slash
    span#mutebutton.input-group-addon(onclick='muteAudio()', style='background-color:#222;color:#999;border-left: none;border-color: #444;outline:none;cursor:pointer;')
      i.fas.fa-volume-up
    span.input-group-addon#emoji-trigger(style='background-color:#222;color:#999;border-color: #444;border-left: none;outline:none;cursor:pointer;')
      i.far.fa-smile-beam
    span#send.input-group-addon(style='background-color:#222;color:#999;border-color: #444;border-top-right-radius:15px;border-bottom-right-radius:15px;outline:none;')
      i.far.fa-paper-plane
  script(src='https://chr15m.github.io/bugout/bugout.min.js')
  script(src='https://unpkg.com/3box/dist/3box.min.js')
  script(src='https://cdn.jsdelivr.net/npm/ipfs-http-client/dist/index.min.js')
  script(type="module").
    import { EmojiButton } from 'https://unpkg.com/@joeattardi/emoji-button@4.1.0/dist/index.js';

    const picker = new EmojiButton({
                      theme: 'dark',
                      position: 'top-start',
                      autoHide: false
                    });
    const trigger = document.querySelector('#emoji-trigger');

    trigger.addEventListener('click', () => picker.togglePicker(trigger));
    picker.on('emoji', selection => {
      document.getElementById("message").value += selection.emoji;
    });
  script.
      var b = Bugout("Kronos");
      console.log(b.address() + " [ me ]");
      //- var c = Bugout("Kronos2"); // 2nd Channel

      const ipfs = window.IpfsHttpClient({ host: 'ipfs.infura.io', port: 5001 });    

      console.log(ipfs);
      
      const audio = new Audio("../notification.wav");
      const audiopm = new Audio("../pmdrop.wav");

      localStorage.debug = "";

      var ethaddy = document.getElementById("ethaccount").getAttribute("data-value");

      var daddy = document.getElementById("daccount").getAttribute("data-value");

      function enterChat() {
        var userinput = $("#entername").val().replace(/</g, "&lt;").replace(/>/g, "&gt;");
        document.getElementById("entername").setAttribute("data-value", userinput);

        if (userinput == '') {
          return false;
        } else {
          $('#logingroup').fadeOut();
          $('#loginbg').fadeOut();
          $('#message').focus();
        }
      }

      document.getElementById("entername").onkeydown = function(e){
        if (e.keyCode == 32){
            return false;
        }
        if(e.keyCode == 13){
          e.preventDefault();
          var userinput = $("#entername").val().replace(/</g, "&lt;").replace(/>/g, "&gt;");

          document.getElementById("entername").setAttribute("data-value", userinput);

          if (userinput == '') {
            return false;
          } else {
            $('#logingroup').fadeOut();
            $('#loginbg').fadeOut();
            $('#message').focus();
          }
        }
      };

      function timeSince(date) {
        var seconds = Math.floor((new Date() - date) / 1000);
        var interval = seconds / 31536000;
        if (interval > 1) {
          return Math.floor(interval) + " years ago";
        }
        interval = seconds / 2592000;
        if (interval > 1) {
          return Math.floor(interval) + " months ago";
        }
        interval = seconds / 86400;
        if (interval > 1) {
          return Math.floor(interval) + " days ago";
        }
        interval = seconds / 3600;
        if (interval > 1) {
          return Math.floor(interval) + " hours ago";
        }
        interval = seconds / 60;
        if (interval > 1) {
          return Math.floor(interval) + " minutes ago";
        }
        return Math.floor(seconds) + " seconds ago";
      }


      let privateuser = 'undefined';
      let privateusername = 'undefined';

      let atregex = new RegExp('/[^@]/u');

      function pmUser(userid, username) {
        if (confirm('Are you sure you want to private message '+username+'?')) {
          //alert('User banned! Refresh if you want to remove the ban.');
          privateuser = userid;
          privateusername = username;
          console.log(privateuser);
          $('#message').val('@'+username+' ');
          $('#message').focus();
          $('#cancelpm').show();
          //bannedusers.push(usertoban);
        } else {
          console.log('User not private messaged');
        }
      }

      function swapPublic() {
        privateuser = 'undefined';
        privateusername = 'undefined';
        $('#message').val('');
        $('#cancelpm').hide();
      }

      document.getElementById("message").onkeydown = function(e){
        if(e.keyCode == 13){
          e.preventDefault();
          var messages = [];
          var boxprofile = document.getElementById("threebox").getAttribute("data-value");
          var username = document.getElementById("entername").getAttribute("data-value");
          var userid = b.address();
          var time = new Date().toUTCString().replace('GMT','');
          var txt = $("#message").val().replace(/</g, "&lt;").replace(/>/g, "&gt;");
          if (txt == '') {
            return;
          }
          messages.push({msg: txt, address: ethaddy, daddress: daddy, boxprofile: boxprofile, time: time, username: username, userid: userid});
          if (privateuser != 'undefined') {
            //alert('Sent to user privately');
            b.send(privateuser, messages);
            $('#messages').append("<div style='position:relative;z-index:1;font-size:13px;color:#999;margin-top:4px !important; background-color:#22222296;border: 1px solid #fff00026;border-radius:15px;' class='row animate__animated animate__flipInX tooltippy'><div class='rainbowbg'></div><div class='PMchat'><div class='col-md-3 tooltippy' align='center' title='"+username+"<br>ARI: "+ethaddy+"<br>D: "+daddy+"'><img src="+boxprofile+" border='0' style='display:inline-block;height:45px;width:45px;border-radius:9999px;object-fit:cover;margin-right: 15px;margin-top:9px;margin-bottom:9px;border: 3px #333 solid;'/><span style='margin-top:15px;'><span id='maintippy' style='font-weight:bold;'>PM SENT</span></span></div><div class='col-md-9' style='display:inline-block;vertical-align:middle;margin-top:3px;'><span id='msgtime' data-value="+time+" style='color: #555;font-size:9px;'>"+time+"</span><br><span style='font-size:16px;color:#FFF;'>"+txt+"</span></div></div></div>");
            tippy('.tooltippy', {
              animateFill: true,
              arrow: true,
              size: 'large',
              duration: 0,
              placement: 'auto',
              animation: 'perspective',
              interactive: true,
              theme: 'material',
            });
            //- var atuser = ['@'+privateusername];

            //- atuser.forEach(function(item){

            //-   $("#messages:contains("+item+")").html(
            //-     function( _ , html ) {
            //-       return html.split(item).join("<span style='background: linear-gradient(317deg, rgba(221,76,76,1) 0%, rgba(208,170,57,1) 100%);-webkit-background-clip: text;background-clip: text;-webkit-text-fill-color: transparent;'><strong>" + item + "</strong></span>");
            //-     }
            //-   )

            //- });
            audiopm.play();
            //b.send(userid, messages);
            $('#message').val('');
            $('#message').val('@'+privateusername+' ');
            //alert('Successfully sent message privately!');
          } else {
            b.send(messages);
            $('#message').val('');
          }
        }
      };

      document.getElementById("send").onmousedown = function(e){
        e.preventDefault();
        var messages = [];
        var time = new Date().toUTCString().replace('GMT','');
        var boxprofile = document.getElementById("threebox").getAttribute("data-value");
        var username = document.getElementById("entername").getAttribute("data-value");
        var userid = b.address();
        var txt = $("#message").val().replace(/</g, "&lt;").replace(/>/g, "&gt;");
        if (txt == '') {
            return;
        }
        messages.push({msg: txt, address: ethaddy, daddress: daddy, boxprofile: boxprofile, time: time, username: username, userid: userid});
        if (privateuser != 'undefined') {
          //alert('Sent to user privately');
          b.send(privateuser, messages);
          $('#messages').append("<div style='position:relative;z-index:1;font-size:13px;color:#999;margin-top:4px !important; background-color:#22222296;border: 1px solid #fff00026;border-radius:15px;' class='row animate__animated animate__flipInX tooltippy'><div class='rainbowbg'></div><div class='PMchat'><div class='col-md-3 tooltippy' align='center' title='"+username+"<br>ARI: "+ethaddy+"<br>D: "+daddy+"'><img src="+boxprofile+" border='0' style='display:inline-block;height:45px;width:45px;border-radius:9999px;object-fit:cover;margin-right: 15px;margin-top:9px;margin-bottom:9px;border: 3px #333 solid;'/><span style='margin-top:15px;'><span id='maintippy' style='font-weight:bold;'>PM SENT</span></span></div><div class='col-md-9' style='display:inline-block;vertical-align:middle;margin-top:3px;'><span id='msgtime' data-value="+time+" style='color: #555;font-size:9px;'>"+time+"</span><br><span style='font-size:16px;color:#FFF;'>"+txt+"</span></div></div></div>");
          tippy('.tooltippy', {
            animateFill: true,
            arrow: true,
            size: 'large',
            duration: 0,
            placement: 'auto',
            animation: 'perspective',
            interactive: true,
            theme: 'material',
          });
          //- var atuser = ['@'+privateusername];

          //- atuser.forEach(function(item){

          //-   $("#messages:contains("+item+")").html(
          //-     function( _ , html ) {
          //-       return html.split(item).join("<span style='background: linear-gradient(317deg, rgba(221,76,76,1) 0%, rgba(208,170,57,1) 100%);-webkit-background-clip: text;background-clip: text;-webkit-text-fill-color: transparent;'><strong>" + item + "</strong></span>");
          //-     }
          //-   )

          //- });
          audiopm.play();
          //b.send(userid, messages);
          $('#message').val('');
          $('#message').val('@'+privateusername+' ');
          //alert('Successfully sent message privately!');
        } else {
          b.send(messages);
          $('#message').val('');
        }
      };

    function muteAudio() {
      var audioElm = audio;
      var audioElm2 = audiopm;
      audioElm.muted = !audioElm.muted;
      audioElm2.muted = !audioElm2.muted;
      if (!audioElm.muted) {
        $("#mutebutton").html("<i class='fas fa-volume-up'></i>");
      } else {
        $("#mutebutton").html("<i class='fas fa-volume-mute'></i>");
      }
    }

    b.on("seen", function(address) { 
      console.log(address + " [ seen ]");
      $('#loader').html("Kronos Chat " + b.address());
      $('#chatinput').show();
    });

    //- var thebox = document.getElementById("threebox").getAttribute("data-value");

    //- $('#thebox').html('<img src="'+thebox+'" style="width:100px;height:100px;"/>');

    b.on("connections", function(connection) { 
        //console.log(connection + " [ connections ]");
        if (connection == 0) {
          $('#connectdot').html(' ◯ Waiting on peers...');
        } else if (connection <= 1) {
          $('#connectdot').html(' ⬤ <strong>'+connection+'</strong> connection');
        } else {
          $('#connectdot').html(' ⬤ <strong>'+connection+'</strong> connections');
        }
    });

    let bannedusers = [];

    function banUser(usertoban) {
      if (confirm('Are you sure you want to ban '+usertoban +'?')) {
        alert('User banned! Refresh if you want to remove the ban.');
        bannedusers.push(usertoban);
      } else {
        console.log('User not banned');
      }
    }

    b.on("message", function(address, message) {
      console.log("Kronos Chat Banned Users: " + bannedusers.join(","));
      user = message[0].username;
      if (bannedusers.some(v => user.includes(v))) {
          console.log("Kronos banned user message incoming matching '" + user + "' - message blocked");
          return;
      } else {
          console.log("No banned user match using '" + user + "'");
      }
      audio.play();
      var username = document.getElementById("entername").getAttribute("data-value");
      if (username == message[0].username) {
        $('#messages').append("<div style='position:relative;z-index:1;font-size:13px;color:#999;margin-top:4px !important; background-color:#22222296;border: 1px solid #fff00026;border-radius:15px;' class='row animate__animated animate__flipInX tooltippy'><div class='rainbowbg'></div><div class='Youchat'><div class='col-md-3 tooltippy' align='center' title='"+message[0].username+"<br>ARI: "+message[0].address+"<br>D: "+message[0].daddress+"'><img src="+message[0].boxprofile+" border='0' style='display:inline-block;height:45px;width:45px;border-radius:9999px;object-fit:cover;margin-right: 15px;margin-top:9px;margin-bottom:9px;border: 3px #333 solid;'/><span style='margin-top:15px;'>From <span id='maintippy' style='font-weight:bold;'>"+message[0].username+"</span></span></div><div class='col-md-9' style='display:inline-block;vertical-align:middle;margin-top:3px;'><span id='msgtime' data-value="+message[0].time+" style='color: #555;font-size:9px;'>"+message[0].time+"</span><br><span style='font-size:16px;color:#FFF;'>"+message[0].msg+"</span></div></div></div>");
      } else {
        $('#messages').append("<div style='font-size:13px;color:#999;margin-top:4px !important; background-color:#22222296;border-radius:15px;padding:10px;' class='row animate__animated animate__flipInX tooltippy'><div class='col-md-3 tooltippy' align='center' title='"+message[0].username+"<br>ARI: "+message[0].address+"<br>D: "+message[0].daddress+"'><img src="+message[0].boxprofile+" border='0' style='display:inline-block;height:45px;width:45px;border-radius:9999px;object-fit:cover;margin-right: 15px;margin-top:9px;margin-bottom:9px;border: 3px #333 solid;'/><span style='margin-top:15px;'>From <span id='maintippy' style='font-weight:bold;'>"+message[0].username+"</span></span></div><div class='col-md-8' style='display:inline-block;vertical-align:middle;margin-top:3px;'><span id='msgtime' data-value="+message[0].time+" style='color: #555;font-size:9px;'>"+message[0].time+"</span><br><span style='font-size:16px;color:#FFF;'>"+message[0].msg+"</span></div><div class='col-md-1' align='right'><button onclick='pmUser(`"+message[0].userid+"`,`"+message[0].username+"`)' style='background-color:#009133;color:#fff;border:none;border-radius:5px;outline:none;cursor:pointer;'>PM</button>&nbsp;&nbsp;<button onclick='banUser(`"+message[0].username+"`)' style='background-color:#910000;color:#fff;border:none;border-radius:5px;outline:none;cursor:pointer;'>Ban</button></div></div>");
      }
      tippy('.tooltippy', {
        animateFill: true,
        arrow: true,
        size: 'large',
        duration: 0,
        placement: 'auto',
        animation: 'perspective',
        interactive: true,
        theme: 'material',
      });
      //- var atuser = ['@'+username];

      //- atuser.forEach(function(item){

      //-   $("#messages:contains("+item+")").html(
      //-     function( _ , html ) {
      //-       return html.split(item).join("<span style='background: linear-gradient(317deg, rgba(221,76,76,1) 0%, rgba(208,170,57,1) 100%);-webkit-background-clip: text;background-clip: text;-webkit-text-fill-color: transparent;'><strong>" + item + "</strong></span>");
      //-     }
      //-   )

      //- });
    });

    //- b.on("connections", console.log.bind(console, "Connections:"));
    //- b.on("seen", console.log.bind(console, "Seen:"));



    //- c.on("seen", function(address) { 
    //-   console.log(address + " [ seen ]");
    //-   $('#loader2').html("Kronos Chat Peer ID: " + b.address() + " <span class='online-icon greenCircle' target='_blank'><span class='ripple greenCircler'></span><span class='ripple greenCircler'></span><span class='ripple greenCircler'></span></span> • CONNECTED <span id='connectdot'></div>");
    //-   b.on("connections", function(connection) { 
    //-     //console.log(connection + " [ connections ]");
    //-     $('#connectdot2').html(' • '+connection + ' connection(s)');
    //-   });
    //- });

    //- setInterval(function(){ 
    //-     var msgtime = document.getElementById("msgtime").getAttribute("data-value");
    //-     var timesince = timeSince(new Date(Date()-msgtime));
    //-     $('#msgtime').html(timesince);       
    //- }, 1000);
